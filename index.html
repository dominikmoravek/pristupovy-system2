<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Professional System v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { background: #0b0f1a; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); }
        .modal { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .status-ok { color: #4ade80; }
        .status-denied { color: #f87171; }
        .user-link:hover { cursor: pointer; color: #3b82f6; background: rgba(59, 130, 246, 0.1); border-radius: 8px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
                <h1 class="text-3xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 uppercase">
                    RFID system
                </h1>
                <p id="debug-text" class="text-gray-500 font-mono text-[10px] mt-1 tracking-widest uppercase">STAV: ODPOJENO</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3">
                <button id="show-chart-btn" class="bg-white/5 hover:bg-white/10 px-5 py-3 rounded-2xl border border-white/10 text-[10px] font-bold transition-all uppercase tracking-widest">
                    üìä Celkov√° Aktivita
                </button>
                <button id="clear-btn" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 px-5 py-3 rounded-2xl border border-red-500/20 text-[10px] font-bold transition-all uppercase tracking-widest">
                    Smazat
                </button>
                <button id="connect" class="bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded-2xl shadow-lg shadow-blue-500/20 font-bold transition-all text-xs">
                    P≈òIPOJIT USB
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10 text-center">
            <div class="glass p-8 rounded-[2rem] border-t-2 border-emerald-500/30">
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2">Autorizov√°no</p>
                <h2 id="ok-count" class="text-6xl font-black italic text-emerald-400">0</h2>
            </div>
            <div class="glass p-8 rounded-[2rem] border-t-2 border-red-500/30">
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2">Odep≈ôeno</p>
                <h2 id="denied-count" class="text-6xl font-black italic text-red-400">0</h2>
            </div>
        </div>

        <div class="glass rounded-[2rem] overflow-hidden shadow-2xl">
            <table class="w-full text-left">
                <thead class="bg-white/5 text-gray-500 text-[10px] uppercase font-bold tracking-[0.2em]">
                    <tr>
                        <th class="p-6">ƒåas</th>
                        <th class="p-6">Osoba</th>
                        <th class="p-6">V√Ωsledek</th>
                    </tr>
                </thead>
                <tbody id="log-table" class="text-sm"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center z-50 modal">
        <div id="modal-box" class="glass w-full max-w-2xl p-8 rounded-[3rem] relative mx-4 border-white/10">
            <button id="close-modal" class="absolute top-8 right-8 text-gray-400 hover:text-white text-3xl transition-transform hover:scale-125">&times;</button>
            
            <div id="modal-content">
                <div id="user-header" class="flex items-center gap-6 mb-8 hidden">
                    <img id="modal-avatar" src="anonym.jpg" class="w-24 h-24 rounded-3xl object-cover bg-gray-800 shadow-2xl shadow-blue-500/10" onerror="this.src='anonym.jpg'">
                    <div>
                        <h2 id="modal-title-user" class="text-4xl font-black tracking-tight leading-none">Jm√©no</h2>
                        <p id="modal-uid" class="text-blue-500 font-mono text-xs mt-2 uppercase tracking-[0.3em] opacity-60"></p>
                    </div>
                </div>

                <div id="system-header" class="mb-8 hidden text-center">
                    <h2 class="text-4xl font-black tracking-tighter uppercase text-blue-400">Statistiky Syst√©mu</h2>
                    <p class="text-gray-500 text-xs mt-2 uppercase tracking-widest">Souhrnn√Ω p≈ôehled v≈°ech aktivit</p>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-white/5 p-5 rounded-3xl border border-white/5 text-center">
                        <p class="text-gray-500 text-[9px] uppercase font-bold tracking-widest mb-1">OK</p>
                        <p id="modal-ok" class="text-2xl font-black text-emerald-400">0</p>
                    </div>
                    <div class="bg-white/5 p-5 rounded-3xl border border-white/5 text-center">
                        <p class="text-gray-500 text-[9px] uppercase font-bold tracking-widest mb-1">CHYBA</p>
                        <p id="modal-denied" class="text-2xl font-black text-red-400">0</p>
                    </div>
                    <div class="bg-white/5 p-5 rounded-3xl border border-white/5 text-center bg-blue-500/5">
                        <p class="text-blue-400 text-[9px] uppercase font-bold tracking-widest mb-1">√öSPƒö≈†NOST</p>
                        <p id="modal-ratio" class="text-2xl font-black text-blue-400">0%</p>
                    </div>
                </div>

                <div class="h-64">
                    <canvas id="modalChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURACE ---
        const userDatabase = {
            "1226DA53": "Dominik Mor√°vek",
            "AABBCCDD": "N√°v≈°tƒõva 1"
            "62CFA051": "Daniel Ulrich"
        };

        let stats = { ok: 0, denied: 0 };
        let userData = {}; 
        let globalHourly = new Array(24).fill(0);
        let port, modalChartObj;

        const debug = document.getElementById('debug-text');
        const synth = window.speechSynthesis;

        function promluv(text) {
            if (synth.speaking) synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'cs-CZ';
            synth.speak(u);
        }

        // --- GRAFY ---
        function initModalChart(dataArray, color = '#3b82f6') {
            const ctx = document.getElementById('modalChart').getContext('2d');
            if (modalChartObj) modalChartObj.destroy();
            modalChartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + "h"),
                    datasets: [{
                        data: dataArray,
                        backgroundColor: color + '99',
                        borderRadius: 8,
                        hoverBackgroundColor: color
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { stepSize: 1, color: '#475569' } },
                        x: { grid: { display: false }, ticks: { color: '#475569' } }
                    }
                }
            });
        }

        // --- MOD√ÅLY ---
        function calculateRatio(ok, denied) {
            const total = ok + denied;
            if (total === 0) return "0%";
            return Math.round((ok / total) * 100) + "%";
        }

        document.getElementById('show-chart-btn').onclick = () => {
            document.getElementById('user-header').classList.add('hidden');
            document.getElementById('system-header').classList.remove('hidden');
            document.getElementById('modal-box').classList.replace('max-w-2xl', 'max-w-4xl'); // Zvƒõt≈°en√≠ pro celkov√Ω graf
            
            document.getElementById('modal-ok').innerText = stats.ok;
            document.getElementById('modal-denied').innerText = stats.denied;
            document.getElementById('modal-ratio').innerText = calculateRatio(stats.ok, stats.denied);
            
            openModal();
            initModalChart(globalHourly, '#60a5fa');
        };

        function showUserProfile(uid) {
            document.getElementById('system-header').classList.add('hidden');
            document.getElementById('user-header').classList.remove('hidden');
            document.getElementById('modal-box').classList.replace('max-w-4xl', 'max-w-2xl');
            
            const user = userData[uid] || { ok: 0, denied: 0, hourly: new Array(24).fill(0) };
            const name = userDatabase[uid] || `Nezn√°m√Ω (${uid})`;
            
            document.getElementById('modal-title-user').innerText = name;
            document.getElementById('modal-uid').innerText = `ID: ${uid}`;
            document.getElementById('modal-avatar').src = `${uid}.jpg`;
            document.getElementById('modal-ok').innerText = user.ok;
            document.getElementById('modal-denied').innerText = user.denied;
            document.getElementById('modal-ratio').innerText = calculateRatio(user.ok, user.denied);
            
            openModal();
            initModalChart(user.hourly, '#10b981');
        }

        function openModal() { document.getElementById('modal-overlay').classList.add('active'); }
        document.getElementById('close-modal').onclick = () => document.getElementById('modal-overlay').classList.remove('active');

        // --- KOMUNIKACE ---
        document.getElementById('connect').onclick = async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                await port.setSignals({ dataTerminalReady: true, requestToSend: true });
                debug.innerText = "STAV: SYST√âM AKTIVN√ç";
                promluv("Termin√°l p≈ôipojen.");
                readLoop();
            } catch (e) { debug.innerText = "STAV: CHYBA P≈òIPOJEN√ç"; }
        };

        async function readLoop() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            let buffer = "";
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                if (buffer.includes("\n")) {
                    const lines = buffer.split(/\r?\n/);
                    buffer = lines.pop();
                    lines.forEach(line => { if (line.trim()) processData(line.trim()); });
                }
            }
        }

        function processData(line) {
            const now = new Date();
            const hour = now.getHours();
            const [type, uid] = line.split(":");
            if (!uid) return;

            if (!userData[uid]) userData[uid] = { ok: 0, denied: 0, hourly: new Array(24).fill(0) };
            const name = userDatabase[uid] || "Nezn√°m√Ω";
            
            if (type === "ACCESS_OK") {
                stats.ok++;
                userData[uid].ok++;
                userData[uid].hourly[hour]++;
                globalHourly[hour]++;
                promluv(`V√≠tejte, ${name}`);
                addLogRow(now.toLocaleTimeString('cs-CZ'), uid, name, "POVOLENO", "status-ok");
            } else {
                stats.denied++;
                userData[uid].denied++;
                promluv("Vstup odep≈ôen");
                addLogRow(now.toLocaleTimeString('cs-CZ'), uid, "Nezn√°m√Ω", "ZAM√çTNUTO", "status-denied");
            }

            document.getElementById('ok-count').innerText = stats.ok;
            document.getElementById('denied-count').innerText = stats.denied;
        }

        function addLogRow(time, uid, name, status, sClass) {
            const table = document.getElementById('log-table');
            const row = table.insertRow(0);
            row.className = "border-b border-white/5 hover:bg-white/5 transition-all";
            row.innerHTML = `
                <td class="p-6 text-gray-500 font-mono text-xs">${time}</td>
                <td class="p-6 font-bold cursor-pointer"><span class="user-link px-3 py-2" onclick="showUserProfile('${uid}')">${name}</span></td>
                <td class="p-6 ${sClass} font-black uppercase italic">${status}</td>
            `;
        }

        document.getElementById('clear-btn').onclick = () => { if(confirm("Restartovat syst√©m?")) location.reload(); };
    </script>
</body>
</html>
