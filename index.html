<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID SYSTEM PRO | Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { background: #0b0f1a; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); }
        .modal { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .status-ok { color: #4ade80; text-shadow: 0 0 10px rgba(74, 222, 128, 0.2); }
        .status-denied { color: #f87171; text-shadow: 0 0 10px rgba(248, 113, 113, 0.2); }
        .user-link:hover { cursor: pointer; color: #3b82f6; background: rgba(59, 130, 246, 0.1); border-radius: 8px; }
        canvas { max-height: 200px !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
                <h1 class="text-4xl font-black tracking-tighter text-white uppercase italic">
                    RFID <span class="text-blue-500">SYSTEM</span>
                </h1>
                <p id="debug-text" class="text-gray-500 font-mono text-[10px] mt-1 tracking-widest uppercase italic">STATUS: OFFLINE</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3">
                <button id="show-chart-btn" class="bg-white/5 hover:bg-white/10 px-6 py-3 rounded-2xl border border-white/10 text-[10px] font-bold transition-all uppercase tracking-[0.2em]">
                    üìä AKTIVITA SYST√âMU
                </button>
                <button id="clear-btn" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 px-6 py-3 rounded-2xl border border-red-500/20 text-[10px] font-bold transition-all uppercase tracking-[0.2em]">
                    RESTART
                </button>
                <button id="connect" class="bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded-2xl shadow-lg shadow-blue-500/20 font-bold transition-all text-xs">
                    P≈òIPOJIT USB
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-center">
            <div class="glass p-8 rounded-[2.5rem] border-t-2 border-emerald-500/30">
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2">Povoleno</p>
                <h2 id="ok-count" class="text-5xl font-black italic text-emerald-400">0</h2>
            </div>
            
            <div class="glass p-8 rounded-[2.5rem] border-t-2 border-blue-500/30 bg-blue-500/5 relative overflow-hidden">
                <p class="text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-2">Celkem pokus≈Ø</p>
                <h2 id="total-count-main" class="text-6xl font-black italic">0</h2>
                <p id="total-ratio-main" class="text-blue-300/50 text-[10px] font-black mt-2 uppercase tracking-widest">√öspƒõ≈°nost: 0%</p>
            </div>

            <div class="glass p-8 rounded-[2.5rem] border-t-2 border-red-500/30">
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2">Odep≈ôeno</p>
                <h2 id="denied-count" class="text-5xl font-black italic text-red-400">0</h2>
            </div>
        </div>

        <div class="glass rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/5">
            <table class="w-full text-left">
                <thead class="bg-white/5 text-gray-500 text-[10px] uppercase font-bold tracking-[0.3em]">
                    <tr>
                        <th class="p-7">ƒåas z√°znamu</th>
                        <th class="p-7">Identita u≈æivatele</th>
                        <th class="p-7">Stav vstupu</th>
                    </tr>
                </thead>
                <tbody id="log-table" class="text-sm"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/95 backdrop-blur-2xl flex items-center justify-center z-50 modal p-4">
        <div id="modal-box" class="glass w-full max-w-4xl p-10 rounded-[3rem] relative border-white/10 overflow-y-auto max-h-[90vh]">
            <button id="close-modal" class="absolute top-8 right-8 text-gray-500 hover:text-white text-4xl transition-all">&times;</button>
            
            <div id="modal-content">
                <div id="user-header" class="flex items-center gap-8 mb-10 hidden">
                    <img id="modal-avatar" src="anonym.jpg" class="w-28 h-28 rounded-[2rem] object-cover bg-gray-800 border-2 border-white/10 shadow-2xl" onerror="this.src='anonym.jpg'">
                    <div>
                        <h2 id="modal-title-user" class="text-5xl font-black tracking-tighter">Jm√©no</h2>
                        <p id="modal-uid" class="text-blue-500 font-mono text-xs mt-3 uppercase tracking-[0.4em] opacity-50"></p>
                    </div>
                </div>

                <div id="system-header" class="mb-10 text-center hidden">
                    <h2 class="text-4xl font-black tracking-tighter uppercase text-blue-400 italic">Anal√Ωza Syst√©mu</h2>
                </div>
                
                <div class="grid grid-cols-3 gap-6 mb-10">
                    <div class="bg-white/5 p-6 rounded-3xl text-center border border-white/5">
                        <p class="text-gray-500 text-[10px] uppercase font-bold tracking-widest mb-2 italic">Povolen√©</p>
                        <p id="modal-ok" class="text-3xl font-black text-emerald-400">0</p>
                    </div>
                    <div class="bg-white/5 p-6 rounded-3xl text-center border border-white/5">
                        <p class="text-gray-500 text-[10px] uppercase font-bold tracking-widest mb-2 italic">Odep≈ôen√©</p>
                        <p id="modal-denied" class="text-3xl font-black text-red-400">0</p>
                    </div>
                    <div class="bg-blue-600/20 p-6 rounded-3xl text-center border border-blue-500/20">
                        <p class="text-blue-400 text-[10px] uppercase font-bold tracking-widest mb-2 italic">√öspƒõ≈°nost</p>
                        <p id="modal-ratio" class="text-3xl font-black text-blue-400">0%</p>
                    </div>
                </div>

                <div class="space-y-8">
                    <div>
                        <p id="chart-label-1" class="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-4 ml-2 italic">Frekvence v≈°ech pokus≈Ø</p>
                        <div class="h-48"><canvas id="modalChartTotal"></canvas></div>
                    </div>
                    <div id="extra-charts" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-white/5">
                        <div>
                            <p class="text-[10px] font-bold uppercase tracking-widest text-emerald-500/50 mb-4 ml-2 italic text-center">Jen povolen√©</p>
                            <div class="h-40"><canvas id="modalChartOk"></canvas></div>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold uppercase tracking-widest text-red-500/50 mb-4 ml-2 italic text-center">Jen odep≈ôen√©</p>
                            <div class="h-40"><canvas id="modalChartDenied"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const userDatabase = {
            "1226DA53": "Dominik Mor√°vek",
            "62CFA051": "Daniel Ulrich"
        };

        let stats = { ok: 0, denied: 0, total: 0 };
        let userData = {}; 
        let globalHrTotal = new Array(24).fill(0);
        let globalHrOk = new Array(24).fill(0);
        let globalHrDenied = new Array(24).fill(0);
        
        let port;
        let chartObjT, chartObjO, chartObjD;

        const synth = window.speechSynthesis;
        function promluv(text) {
            if (synth.speaking) synth.cancel();
            const u = new SpeechSynthesisUtterance(text); u.lang = 'cs-CZ'; synth.speak(u);
        }

        function calculateRatio(ok, denied) {
            const sum = ok + denied;
            return sum === 0 ? "0%" : Math.round((ok / sum) * 100) + "%";
        }

        // --- UNIVERZ√ÅLN√ç TV≈ÆRCE GRAF≈Æ ---
        function createChart(id, data, color) {
            const ctx = document.getElementById(id).getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + "h"),
                    datasets: [{ data: data, backgroundColor: color, borderRadius: 6 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { display: false }, ticks: { display: false } },
                        x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9 } } }
                    }
                }
            });
        }

        // --- MOD√ÅL: CELKOV√Å AKTIVITA ---
        document.getElementById('show-chart-btn').onclick = () => {
            document.getElementById('user-header').classList.add('hidden');
            document.getElementById('system-header').classList.remove('hidden');
            document.getElementById('extra-charts').classList.remove('hidden');
            document.getElementById('chart-label-1').innerText = "Vyt√≠≈æen√≠ termin√°lu (Celkem)";
            
            document.getElementById('modal-ok').innerText = stats.ok;
            document.getElementById('modal-denied').innerText = stats.denied;
            document.getElementById('modal-ratio').innerText = calculateRatio(stats.ok, stats.denied);
            
            openModal();
            if(chartObjT) chartObjT.destroy(); if(chartObjO) chartObjO.destroy(); if(chartObjD) chartObjD.destroy();
            chartObjT = createChart('modalChartTotal', globalHrTotal, '#3b82f6');
            chartObjO = createChart('modalChartOk', globalHrOk, '#10b981');
            chartObjD = createChart('modalChartDenied', globalHrDenied, '#ef4444');
        };

        // --- MOD√ÅL: PROFIL U≈ΩIVATELE ---
        function showUserProfile(uid) {
            document.getElementById('system-header').classList.add('hidden');
            document.getElementById('user-header').classList.remove('hidden');
            document.getElementById('extra-charts').classList.add('hidden');
            document.getElementById('chart-label-1').innerText = "Historie aktivity u≈æivatele";
            
            const user = userData[uid] || { ok: 0, denied: 0, hourly: new Array(24).fill(0) };
            const name = userDatabase[uid] || `Neautorizov√°no (${uid})`;
            
            document.getElementById('modal-title-user').innerText = name;
            document.getElementById('modal-uid').innerText = `ƒåIP: ${uid}`;
            document.getElementById('modal-avatar').src = `${uid}.jpg`;
            document.getElementById('modal-ok').innerText = user.ok;
            document.getElementById('modal-denied').innerText = user.denied;
            document.getElementById('modal-ratio').innerText = calculateRatio(user.ok, user.denied);
            
            openModal();
            if(chartObjT) chartObjT.destroy();
            chartObjT = createChart('modalChartTotal', user.hourly, '#10b981');
        }

        function openModal() { document.getElementById('modal-overlay').classList.add('active'); }
        document.getElementById('close-modal').onclick = () => document.getElementById('modal-overlay').classList.remove('active');

        // --- USB ---
        document.getElementById('connect').onclick = async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                await port.setSignals({ dataTerminalReady: true, requestToSend: true });
                document.getElementById('debug-text').innerText = "STATUS: ONLINE";
                promluv("Syst√©m p≈ôipraven.");
                readLoop();
            } catch (e) { document.getElementById('debug-text').innerText = "STATUS: CHYBA"; }
        };

        async function readLoop() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            let buffer = "";
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                if (buffer.includes("\n")) {
                    const lines = buffer.split(/\r?\n/);
                    buffer = lines.pop();
                    lines.forEach(line => { if (line.trim()) processData(line.trim()); });
                }
            }
        }

        function processData(line) {
            const now = new Date();
            const hour = now.getHours();
            const [type, uid] = line.split(":");
            if (!uid) return;

            if (!userData[uid]) userData[uid] = { ok: 0, denied: 0, hourly: new Array(24).fill(0) };
            const name = userDatabase[uid] || `Neautorizov√°no (${uid})`;
            
            stats.total++;
            globalHrTotal[hour]++;

            if (type === "ACCESS_OK") {
                stats.ok++;
                userData[uid].ok++;
                userData[uid].hourly[hour]++;
                globalHrOk[hour]++;
                promluv(`V√≠tejte, ${name}`);
                addLogRow(now.toLocaleTimeString('cs-CZ'), uid, name, "POVOLENO", "status-ok");
            } else {
                stats.denied++;
                userData[uid].denied++;
                // Nepovolen√© vstupy se u u≈æivatele taky loguj√≠ do grafu
                userData[uid].hourly[hour]++; 
                globalHrDenied[hour]++;
                promluv("Odep≈ôeno.");
                addLogRow(now.toLocaleTimeString('cs-CZ'), uid, name, "ODEP≈òENO", "status-denied");
            }

            document.getElementById('ok-count').innerText = stats.ok;
            document.getElementById('denied-count').innerText = stats.denied;
            document.getElementById('total-count-main').innerText = stats.total;
            document.getElementById('total-ratio-main').innerText = "√öspƒõ≈°nost: " + calculateRatio(stats.ok, stats.denied);
        }

        function addLogRow(time, uid, name, status, sClass) {
            const table = document.getElementById('log-table');
            const row = table.insertRow(0);
            row.className = "border-b border-white/5 hover:bg-white/5 transition-all group";
            row.innerHTML = `
                <td class="p-7 text-gray-500 font-mono text-[11px]">${time}</td>
                <td class="p-7 font-bold"><span class="user-link px-3 py-2" onclick="showUserProfile('${uid}')">${name}</span></td>
                <td class="p-7 ${sClass} font-black uppercase italic text-xs tracking-tighter">${status}</td>
            `;
        }

        document.getElementById('clear-btn').onclick = () => { if(confirm("Restartovat sezen√≠?")) location.reload(); };
    </script>
</body>
</html>
